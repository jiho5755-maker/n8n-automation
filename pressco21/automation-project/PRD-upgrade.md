# 업무 일정 자동화 시스템 고도화 PRD

## 문서 정보
- **작성일**: 2026-02-25
- **기반 문서**: PRD.md (Phase 1~3 완료 기준)
- **현재 운영 상태**: F1 + F2 + F3 + F4 모두 운영 중

---

## 목적

텔레그램 봇 입력을 자유로운 자연어로 처리하고, 봇 커맨드와 인라인 버튼으로 상태 관리를 편리하게 하며, 노션과 구글 캘린더의 양방향 동기화를 완성한다.

## 사용자

1인 운영자(장지호). 이동 중이나 작업 중에 3초 이내로 업무를 입력하고, 텔레그램에서 즉시 상태를 변경하며, 노션과 구글 캘린더 어느 쪽에서 수정해도 양쪽이 자동으로 일치 상태를 유지한다.

---

## 사용자 여정

```
[텔레그램 자연어 입력]
  "내일 오후 3시 팀 미팅 준비"
  ↓ AI 파싱 (Gemini 2.0 Flash)
  ↓ 실패 시 → Regex 폴백 파서
  ↓
[Notion 할 일 생성 + 구글 캘린더 이벤트 생성(F5)]
  ↓
[텔레그램 확인 메시지 + 인라인 버튼]
  [✅ 완료] [🔵 진행중] [📌 핀]
  ↓ 버튼 클릭 시
[Notion 상태 즉시 업데이트 + 텔레그램 메시지 수정]

[텔레그램 /주간 커맨드]
  ↓
[Notion 이번 주(월~일) 할 일 전체 조회]
  ↓
[텔레그램 주간 현황 + 완료율 통계 발송]

[텔레그램 /수정 커맨드]
  ↓
[Notion 해당 할 일 수정 + 구글 캘린더 이벤트도 자동 수정(F5)]
  ↓
[텔레그램 수정 완료 확인 메시지]

[Notion 할 일 추가/수정 (Notion 앱 직접 입력)]
  ↓ 5분 폴링 (F5)
  ↓ 메모 필드 [gcal:이벤트ID] 유무 확인
  [없음] → 구글 캘린더 이벤트 신규 생성 → 메모에 [gcal:이벤트ID] 기록
  [있음] → 구글 캘린더 이벤트 업데이트
```

---

## 기능 명세

### 1. 신규/업그레이드 핵심 기능

| ID | 기능명 | 설명 | 필수 이유 | 관련 모듈 |
|----|--------|------|-----------|-----------|
| **F1-AI** | AI 자연어 파싱 | Gemini 2.0 Flash로 자유 입력 텍스트 파싱. 실패 시 기존 Regex 폴백 | 3초 입력의 핵심. 형식 강요 제거 | F1 텔레그램 봇 워크플로우 |
| **F1-CMD** | 텔레그램 커맨드 확장 | /주간 (주간 현황 + 완료율), /수정 [번호] [내용/날짜] | 텔레그램 내에서 조회·수정 완결 | F1 텔레그램 봇 워크플로우 |
| **F1-BTN** | 인라인 키보드 버튼 | 할 일 등록 후 [✅ 완료] [🔵 진행중] [📌 핀] 버튼으로 즉시 상태 변경 | 노션 앱 진입 없이 상태 처리 | F1 텔레그램 봇 워크플로우, Callback 처리 워크플로우 |
| **F5** | 노션 → 구글 캘린더 역방향 동기화 | 5분 폴링으로 노션 변경 감지 → 구글 캘린더 이벤트 생성/수정. 메모 필드 [gcal:이벤트ID]로 중복 방지 | 기존 F2 단방향 완성, 양방향 일치 | F5 역방향 동기화 워크플로우 |

### 2. 지원 기능

| ID | 기능명 | 설명 | 필수 이유 | 관련 모듈 |
|----|--------|------|-----------|-----------|
| **F-CALLBACK** | 인라인 버튼 콜백 수신 | Telegram Webhook callback_query 수신 처리. n8n Telegram 노드 v1.2 미지원 → HTTP 직접 호출 | F1-BTN 동작의 전제 | Callback 처리 워크플로우 |
| **F-GCAL-ID** | 구글 캘린더 이벤트 ID 관리 | Notion 메모 필드에 [gcal:이벤트ID] 태그 읽기/쓰기 | F5 중복 방지의 핵심 | F5 역방향 동기화 워크플로우 |

### 3. 기존 유지 기능 (변경 없음)

| ID | 기능명 | 설명 |
|----|--------|------|
| F2 | 구글 캘린더 → 노션 동기화 | 기존 단방향 유지 (F5와 충돌 없도록 방향 구분) |
| F3 | 모닝 브리핑 | 매일 08:00 텔레그램 발송 |
| F4 | 밀린 업무 알림 | 매일 10:00 텔레그램 발송 |

### 4. MVP 이후 기능 (이번 범위 제외)

- 다중 사용자 지원
- 노션 할 일 삭제 시 구글 캘린더 이벤트 삭제 동기화
- AI가 프로젝트를 자동 추천
- 음성 메모 파싱

---

## 모듈 구조

```
텔레그램 봇 워크플로우 (F1 업그레이드)
├── 메시지 수신 분기
│   ├── 일반 텍스트 → AI 파싱 (F1-AI) → Regex 폴백 → Notion 등록 → 인라인 버튼 발송 (F1-BTN)
│   ├── /주간 → 주간 현황 조회 및 발송 (F1-CMD)
│   ├── /수정 [번호] [내용] → Notion 수정 → F5 자동 반영 (F1-CMD)
│   ├── /목록 → 오늘 할 일 조회 (기존 유지)
│   ├── /완료 [번호] → 상태 변경 (기존 유지)
│   └── /밀린 → 밀린 업무 조회 (기존 유지)
│
Callback 처리 워크플로우 (신규)
├── Telegram callback_query 수신 (HTTP Webhook)
├── callback_data 파싱 → notionPageId + 상태값
├── Notion 상태 업데이트
└── Telegram answerCallbackQuery + 메시지 수정
│
F5 역방향 동기화 워크플로우 (신규)
├── 5분 Schedule Trigger
├── Notion 할 일 DB 조회 (최근 5분 내 생성/수정, 시간 필드 있는 항목)
├── 메모 필드 [gcal:이벤트ID] 파싱
├── [없음] → Google Calendar 이벤트 생성 → Notion 메모에 ID 기록
└── [있음] → Google Calendar 이벤트 업데이트
│
F2 기존 워크플로우 (유지)
└── Google Calendar → Notion (단방향, F5와 방향 반대이므로 충돌 없음)
│
F3 모닝 브리핑 (유지)
│
F4 밀린 업무 알림 (유지)
```

---

## 모듈별 상세 기능

### F1-AI: AI 자연어 파싱 모듈

> **구현 기능:** `F1-AI` | **위치:** F1 텔레그램 봇 워크플로우 내 Code 노드 직전

| 항목 | 내용 |
|------|------|
| **역할** | 자유 형식 텍스트를 파싱하여 구조화된 할 일 데이터로 변환 |
| **진입 조건** | 텔레그램에서 커맨드(/로 시작)가 아닌 일반 텍스트 메시지 수신 시 |
| **처리 흐름** | Gemini HTTP Request → 응답 JSON 파싱 → 실패 시 기존 Regex 파서로 폴백 |
| **주요 기능** | Gemini 2.0 Flash API 호출 (일 1,500회 무료 한도 내 운영). 프롬프트에 오늘 날짜(KST) 포함하여 상대 날짜 계산. 출력 스키마: `{"title": "", "projectHint": "", "date": "YYYY-MM-DD", "time": "HH:mm", "dueDate": "YYYY-MM-DD", "memo": ""}`. 파싱 불가 필드는 null 반환. AI 호출 타임아웃 5초 초과 시 즉시 폴백 처리 |
| **폴백 동작** | Gemini 실패(타임아웃/오류/파싱 불가) 시 기존 `프로젝트 - 할 일 @날짜 시간 ~목표날짜 #메모` Regex 파서로 처리. 폴백 사용 시 회신 메시지에 "(기본 파서 사용)" 표시 |

---

### F1-CMD: 텔레그램 커맨드 확장 모듈

> **구현 기능:** `F1-CMD` | **위치:** F1 텔레그램 봇 워크플로우 내 분기 처리

| 항목 | 내용 |
|------|------|
| **역할** | /주간 및 /수정 커맨드를 처리하여 주간 현황 조회와 할 일 수정 기능 제공 |
| **진입 조건** | 텔레그램 메시지가 /주간 또는 /수정으로 시작하는 경우 |
| **사용자 행동** | `/주간` 입력 → 이번 주 월~일 전체 할 일과 완료율 수신. `/수정 3 @내일` 또는 `/수정 3 새로운 내용` 입력 → 해당 번호 할 일 수정 |
| **주요 기능** | **[/주간]** 이번 주 월요일 00:00 ~ 일요일 23:59 KST 범위로 Notion 할 일 DB 조회. 프로젝트별 그룹화. 완료율 = 완료 건수 / 전체 건수 × 100. **[/수정]** `/목록` 또는 `/주간` 응답의 번호(1-based 인덱스)를 기준으로 수정 대상 특정. `@날짜` 형식이면 시간 필드 변경. 그 외는 제목 변경. 수정 후 F5 워크플로우에서 자동으로 구글 캘린더에도 반영됨 |
| **출력 메시지 형식** | 아래 "응답 메시지 형식" 섹션 참조 |

---

### F1-BTN: 인라인 키보드 버튼 모듈

> **구현 기능:** `F1-BTN`, `F-CALLBACK` | **위치:** F1 워크플로우 (발송), Callback 워크플로우 (수신)

| 항목 | 내용 |
|------|------|
| **역할** | 할 일 등록 완료 메시지에 인라인 버튼을 첨부하여 노션 앱 진입 없이 상태 변경 |
| **진입 조건** | 텔레그램 자연어 입력으로 할 일이 정상 등록된 직후 |
| **사용자 행동** | 확인 메시지 하단 버튼 클릭 → 즉시 Notion 상태 업데이트 → 메시지 아이콘 변경으로 처리 완료 확인 |
| **주요 기능** | Telegram sendMessage API 직접 HTTP 호출 (n8n Telegram 노드 v1.2 reply_markup 미지원 우회). `callback_data` = `{상태코드}:{notionPageId}` 형식 (최대 64바이트 제한 준수). 버튼 3개: `done:{pageId}` / `inprogress:{pageId}` / `pin:{pageId}`. 상태 코드 → Notion 상태 값 매핑: done=완료, inprogress=진행 중, pin=핀 |
| **Callback 처리** | Telegram Webhook으로 callback_query 수신 → `answerCallbackQuery` 즉시 응답(텔레그램 로딩 스피너 제거) → Notion PATCH API로 상태 업데이트 → `editMessageText` 또는 `editMessageReplyMarkup`으로 버튼 제거 및 처리 완료 표시 |

---

### F5: 노션 → 구글 캘린더 역방향 동기화 워크플로우

> **구현 기능:** `F5`, `F-GCAL-ID` | **유형:** 신규 독립 워크플로우

| 항목 | 내용 |
|------|------|
| **역할** | Notion에서 직접 입력하거나 /수정 커맨드로 변경된 할 일을 구글 캘린더에 자동 반영 |
| **진입 조건** | 5분 Schedule Trigger. 최근 5분 이내 `last_edited_time`이 변경되고 `시간` 필드(date)가 null이 아닌 Notion 할 일 항목 |
| **사용자 행동** | Notion에서 할 일 추가 또는 수정 → 최대 5분 내 구글 캘린더에 자동 반영됨 |
| **주요 기능** | Notion DB 조회 (`filter.timestamp = last_edited_time`, `after = 현재 - 5분`). 메모 필드에서 `[gcal:이벤트ID]` 정규식 추출. **[이벤트ID 없음]** Google Calendar Events.insert → 생성된 이벤트 ID를 Notion 메모 필드 맨 앞에 `[gcal:이벤트ID] ` 형태로 prepend하여 저장. **[이벤트ID 있음]** Google Calendar Events.patch로 제목/시간 업데이트. F2 워크플로우(구글→노션 방향)와 충돌 방지: F2 처리 시 Notion에 `[from-gcal]` 태그를 메모에 기록하고, F5는 이 태그가 있는 항목은 건너뜀 |
| **Notion Rate Limit 대응** | 항목 간 처리에 334ms 딜레이 적용 (초당 3회 제한 준수). 429 응답 시 1회 자동 재시도 (1초 대기) |
| **타임존 처리** | 모든 날짜 계산은 KST(UTC+9) 기준. n8n 서버 UTC → KST 변환 시 `moment().utcOffset('+09:00')` 패턴 사용 |

---

### Callback 처리 워크플로우 (신규 독립 워크플로우)

> **구현 기능:** `F-CALLBACK` | **유형:** Webhook Trigger 기반 신규 워크플로우

| 항목 | 내용 |
|------|------|
| **역할** | 인라인 버튼 클릭 시 Telegram에서 전송하는 callback_query를 수신하여 처리 |
| **진입 조건** | Telegram이 n8n Webhook URL로 callback_query 이벤트 POST 요청 전송 시 |
| **처리 흐름** | Webhook 수신 → `callback_data` 파싱 (`상태코드:pageId`) → Telegram `answerCallbackQuery` 즉시 호출(200ms 내) → Notion 상태 PATCH → Telegram `editMessageReplyMarkup`으로 버튼 제거 + 완료 텍스트 추가 |
| **주요 기능** | callback_data 포맷 검증 (콜론 구분자 존재 여부). 잘못된 형식이면 answerCallbackQuery만 호출하고 종료. Notion 업데이트 실패 시 answerCallbackQuery에 "처리 실패" 텍스트 표시 |
| **보안** | Webhook URL에 랜덤 path 적용 (n8n 자동 생성 UUID 활용). Telegram Header X-Telegram-Bot-Api-Secret-Token 검증 |

---

## 응답 메시지 형식

### 할 일 등록 완료 (인라인 버튼 포함)

```
등록 완료
─────────────────
팀 미팅 준비
프로젝트: n8n 자동화 구축
날짜: 2/26(목) 15:00
─────────────────
[✅ 완료] [🔵 진행중] [📌 핀]
```

### /주간 응답

```
주간 현황 (2/24 월 ~ 3/2 일)
─────────────────────────────
완료율: 4/9건 (44%)

📁 n8n 자동화 구축
  1. ✅ F5 워크플로우 구현
  2. ⬜ AI 파싱 테스트
  3. ⬜ 인라인 버튼 배포

📁 홈페이지 리뉴얼
  4. 🔵 메인 배너 수정
  5. ✅ 상품 이미지 교체

─────────────────────────────
✅ 완료 4 | 🔵 진행중 1 | ⬜ 시작 전 4
```

### /수정 응답

```
수정 완료
─────────────────
팀 미팅 준비
날짜: 2/26(목) → 2/27(금) 15:00
구글 캘린더도 자동 반영됩니다
```

---

## 데이터 모델

### 할 일 DB (기존 + 메모 필드 활용 확장)

| 필드 | 설명 | 타입/관계 |
|------|------|-----------|
| id | 고유 식별자 | UUID (Notion page_id) |
| 할 일 | 태스크 제목 | title |
| 상태 | 시작 전 / 진행 중 / 완료 / 핀 등 | status |
| 시간 | 작업 일시 | date |
| 목표날짜 | 마감일 | date |
| 프로젝트 | 프로젝트 연결 | → 프로젝트 DB |
| 캘린더 | 날짜 허브 연결 | → 캘린더 DB |
| 메모 | 상세 내용 + 시스템 태그 보관소 | text |

**메모 필드 시스템 태그 규칙**

| 태그 | 형식 | 작성 주체 | 용도 |
|------|------|-----------|------|
| 구글 캘린더 이벤트 ID | `[gcal:이벤트ID]` | F5 워크플로우 | 역방향 동기화 중복 방지 |
| 구글 캘린더 유래 표시 | `[from-gcal]` | F2 워크플로우 | F5에서 F2 출처 항목 건너뜀 |

---

## 기술 스택

### 자동화 엔진

- **n8n (self-hosted)** - 워크플로우 실행 엔진. 기존 운영 중인 인스턴스 그대로 사용

### AI 파싱

- **Gemini 2.0 Flash API** - 자연어 → 구조화 데이터 변환. 무료 티어 일 1,500회 한도

### 연동 서비스 (기존 Credential 재사용)

- **Notion API** - 할 일 DB CRUD. Rate Limit 초당 3회 준수
- **Google Calendar API** - 이벤트 생성/수정. OAuth 2.0 기존 연동
- **Telegram Bot API** - 메시지 수신/발송. sendMessage, editMessageText, answerCallbackQuery 직접 HTTP 호출

### 인프라 (변경 없음)

- **Oracle Cloud Free Tier ARM** - n8n 서버 (n8n.pressco21.com)
- **PostgreSQL** (Docker) - n8n 실행 데이터 저장

---

## 기술 제약 및 대응

| 제약 | 내용 | 대응 방법 |
|------|------|-----------|
| n8n Telegram 노드 v1.2 | reply_markup 파라미터 미지원 | sendMessage, editMessageText, answerCallbackQuery 모두 HTTP Request 노드로 Telegram Bot API 직접 호출 |
| callback_data 크기 제한 | 최대 64바이트 | `상태코드:pageId` 형식. 상태 코드는 최대 10자(`inprogress`), UUID는 36자. 합계 47바이트로 제한 내 처리 |
| 서버 타임존 UTC | 날짜 계산 오류 위험 | 모든 날짜 처리에 `+09:00` 오프셋 명시. Gemini 프롬프트에도 현재 KST 날짜를 명시하여 전달 |
| Notion Rate Limit | 초당 3회 제한 | F5에서 항목 간 334ms 딜레이. 429 응답 시 1회 재시도 |
| Gemini API 지연 | 응답 지연 시 사용자 대기 발생 | 타임아웃 5초 설정. 초과 시 즉시 Regex 폴백으로 전환하여 응답 보장 |
| F2 ↔ F5 충돌 | 구글→노션→구글 무한루프 가능 | F2가 Notion 생성 시 메모에 `[from-gcal]` 기록. F5는 해당 태그 항목 건너뜀 |

---

## 구현 순서

### Phase A: AI 파싱 (F1-AI)

1. Gemini API Credential을 n8n에 등록 (HTTP Header Auth: `x-goog-api-key`)
2. F1 워크플로우 내 텍스트 파싱 Code 노드 앞에 HTTP Request 노드 추가
3. Gemini 프롬프트 작성 (오늘 날짜 KST 포함, 출력 JSON 스키마 명시)
4. 응답 파싱 성공 여부 If 노드로 분기 → 실패 시 기존 Regex 노드로 연결
5. 테스트: "내일 오후 3시 팀 미팅", "다음주 월요일까지 보고서 제출" 등 자연어 입력 검증

### Phase B: 인라인 버튼 (F1-BTN + Callback 워크플로우)

1. Callback 처리 워크플로우 신규 생성 (Webhook Trigger)
2. F1 워크플로우의 Telegram 응답 노드를 HTTP Request로 교체 (sendMessage + reply_markup)
3. callback_data 형식 정의: `done:{pageId}`, `inprogress:{pageId}`, `pin:{pageId}`
4. Callback 워크플로우에서 answerCallbackQuery → Notion PATCH → editMessageReplyMarkup 구현
5. Telegram setWebhook으로 n8n Webhook URL 등록
6. 테스트: 버튼 클릭 후 Notion 상태 변경 및 메시지 수정 확인

### Phase C: 커맨드 확장 (F1-CMD)

1. F1 워크플로우 최상단 Switch 노드에 `/주간`, `/수정` 분기 추가
2. /주간: 이번 주 월~일 KST 범위 계산 → Notion 쿼리 → 프로젝트별 그룹화 → 메시지 포맷팅
3. /수정: 번호 파싱 → 세션 없이 처리하기 위해 최근 `/목록` 또는 `/주간` 결과를 n8n static data에 임시 저장 → Notion PATCH
4. 테스트: `/주간`, `/수정 2 @내일`, `/수정 3 새 제목` 입력 검증

### Phase D: 역방향 동기화 (F5)

1. F2 워크플로우 수정: Notion 할 일 생성 시 메모 필드에 `[from-gcal]` 태그 추가
2. F5 워크플로우 신규 생성 (5분 Schedule Trigger)
3. Notion 쿼리: `filter.timestamp = last_edited_time`, 5분 이내 변경, 시간 필드 not null, `[from-gcal]` 없는 항목
4. 메모 필드 `[gcal:이벤트ID]` 파싱 → 없으면 생성, 있으면 업데이트
5. 생성 후 Notion 메모 필드 업데이트 (기존 메모 내용 보존하며 태그만 prepend)
6. 테스트: Notion 직접 입력 → 5분 내 구글 캘린더 반영 확인. /수정 후 양쪽 반영 확인

---

## 검증 기준

| 항목 | 기준 |
|------|------|
| AI 파싱 성공률 | "내일 오후 3시", "다음주 금요일", "3/15" 등 10가지 자연어 패턴에서 8/10 이상 정확 파싱 |
| AI 폴백 동작 | Gemini 응답 없을 때 5초 내 Regex 파서로 자동 전환되어 할 일 정상 등록 |
| 인라인 버튼 응답 | 버튼 클릭 후 3초 내 Notion 상태 변경 + 텔레그램 버튼 제거 확인 |
| /주간 완료율 | 실제 Notion 데이터와 일치하는 완료율(%) 표시 |
| /수정 반영 | /수정 명령 후 Notion 및 구글 캘린더 모두 5분 내 업데이트 확인 |
| F5 역방향 동기화 | Notion 직접 입력 후 5분 내 구글 캘린더 이벤트 생성 확인 |
| 충돌 방지 | 구글 캘린더에서 입력한 항목이 F5에 의해 재처리되지 않음 확인 |
| Rate Limit 준수 | F5에서 10건 이상 동시 처리 시 429 오류 없이 완료 |
